# ============================================================
# ClawDeck Release Pipeline
# ============================================================
#
# Triggers on: git tag + GitHub Release (published)
#
# Flow:
#   1. Build & archive with xcodebuild
#   2. Sign with Developer ID certificate
#   3. Notarize with Apple
#   4. Create DMG with drag-to-Applications
#   5. Sign DMG with Sparkle EdDSA key
#   6. Upload DMG to GitHub Release
#   7. Generate & publish appcast.xml for Sparkle auto-updates
#
# Required secrets (see docs/RELEASE.md):
#   DEV_ID_P12_BASE64, DEV_ID_P12_PASSWORD,
#   APPLE_ID, APPLE_TEAM_ID, APPLE_APP_PASSWORD,
#   SPARKLE_PRIVATE_KEY, UPDATES_PAT
# ============================================================

name: Release ClawDeck

on:
  release:
    types: [published]

env:
  APP_NAME: ClawDeck
  SCHEME: ClawDeck
  BUNDLE_ID: com.1devstudio.ClawDeck

permissions:
  contents: write

jobs:
  build-sign-release:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # ── Select Xcode version ──
      - name: Select Xcode
        run: |
          # Use the latest Xcode available on the runner
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [[ -n "$XCODE_PATH" ]]; then
            sudo xcode-select -s "$XCODE_PATH"
          fi
          xcodebuild -version
          echo "Selected: $(xcode-select -p)"

      # ── Resolve SPM dependencies ──
      - name: Resolve dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "$APP_NAME.xcodeproj" \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath .spm-packages

      # ── Import Developer ID certificate ──
      - name: Import signing certificate
        env:
          DEV_ID_P12_BASE64: ${{ secrets.DEV_ID_P12_BASE64 }}
          DEV_ID_P12_PASSWORD: ${{ secrets.DEV_ID_P12_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN=build.keychain
          KEYCHAIN_PW=$(uuidgen)

          # Create a temporary keychain for CI
          security create-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN"
          security list-keychains -d user -s "$KEYCHAIN" login.keychain
          security default-keychain -s "$KEYCHAIN"

          # Import the .p12 certificate
          echo "$DEV_ID_P12_BASE64" | base64 --decode > dev_id.p12
          security import dev_id.p12 -k "$KEYCHAIN" \
            -P "${DEV_ID_P12_PASSWORD:-}" \
            -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PW" "$KEYCHAIN"
          rm dev_id.p12

          # Verify the certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN" | grep "Developer ID"

      # ── Build & Archive ──
      - name: Archive
        run: |
          xcodebuild clean archive \
            -project "$APP_NAME.xcodeproj" \
            -scheme "$SCHEME" \
            -archivePath "$APP_NAME.xcarchive" \
            -clonedSourcePackagesDirPath .spm-packages \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain --timestamp --options runtime"

      # ── Export .app from archive ──
      - name: Export app
        run: |
          cat > export_options.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$APP_NAME.xcarchive" \
            -exportPath Release \
            -exportOptionsPlist export_options.plist

      # ── Notarize ──
      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Zip for notarization submission
          ditto -c -k --sequesterRsrc --keepParent \
            "Release/$APP_NAME.app" "$APP_NAME-notarize.zip"

          # Submit and wait (10 min timeout)
          xcrun notarytool submit "$APP_NAME-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait --timeout 600

          # Staple the notarization ticket to the app
          xcrun stapler staple "Release/$APP_NAME.app"
          rm "$APP_NAME-notarize.zip"

      # ── Create DMG ──
      - name: Create DMG
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          brew install create-dmg

          # create-dmg returns exit code 2 for "DMG created but background not set"
          # which is fine — we don't use a custom background image
          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME.app" 150 185 \
            --app-drop-link 450 185 \
            --hide-extension "$APP_NAME.app" \
            "$APP_NAME-$VERSION.dmg" \
            "Release/$APP_NAME.app" || true

          # Verify DMG was created
          ls -lh "$APP_NAME-$VERSION.dmg"

          # Notarize the DMG too
          xcrun notarytool submit "$APP_NAME-$VERSION.dmg" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_APP_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait --timeout 600

          xcrun stapler staple "$APP_NAME-$VERSION.dmg"

          # Create stable-name copy for "latest" download link
          cp "$APP_NAME-$VERSION.dmg" "$APP_NAME.dmg"

      # ── Sign update with Sparkle EdDSA key ──
      - name: Setup Sparkle tools
        run: |
          SPARKLE_VERSION="2.8.1"
          curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/$SPARKLE_VERSION/Sparkle-$SPARKLE_VERSION.tar.xz" \
            | tar xJ -C /tmp
          echo "/tmp/bin" >> "$GITHUB_PATH"

      - name: Sign update with EdDSA
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key

          # sign_update outputs: sparkle:edSignature="..." length="..."
          SIGN_OUTPUT=$(/tmp/bin/sign_update "$APP_NAME-$VERSION.dmg" \
            -f /tmp/sparkle_key)
          echo "SPARKLE_SIGNATURE=$SIGN_OUTPUT" >> "$GITHUB_ENV"

          rm /tmp/sparkle_key

      # ── Generate appcast.xml ──
      - name: Generate appcast
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PUBDATE=$(date -R)

          cat > appcast.xml << 'APPCAST_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0"
               xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle"
               xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>ClawDeck Changelog</title>
              <link>https://1devstudio.github.io/clawdeck-updates/appcast.xml</link>
              <description>Most recent changes with links to updates.</description>
              <language>en</language>
              <item>
                <title>PLACEHOLDER</title>
                <description><![CDATA[<pre>RELEASE_NOTES_PLACEHOLDER</pre>]]></description>
                <pubDate>PUBDATE_PLACEHOLDER</pubDate>
                <enclosure
                  url="DOWNLOAD_URL_PLACEHOLDER"
                  SPARKLE_SIG_PLACEHOLDER
                  type="application/octet-stream"
                  sparkle:version="VERSION_PLACEHOLDER"
                  sparkle:shortVersionString="VERSION_PLACEHOLDER" />
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
              </item>
            </channel>
          </rss>
          APPCAST_EOF

          # Safe substitutions via sed (no shell expansion issues)
          sed -i '' "s|DOWNLOAD_URL_PLACEHOLDER|https://github.com/1devstudio/clawdeck/releases/download/v$VERSION/$APP_NAME-$VERSION.dmg|g" appcast.xml
          sed -i '' "s|SPARKLE_SIG_PLACEHOLDER|$SPARKLE_SIGNATURE|g" appcast.xml
          sed -i '' "s|VERSION_PLACEHOLDER|$VERSION|g" appcast.xml
          sed -i '' "s|PUBDATE_PLACEHOLDER|$PUBDATE|g" appcast.xml
          sed -i '' "s|<title>PLACEHOLDER</title>|<title>Version $VERSION</title>|g" appcast.xml

          # Replace release notes (may contain special chars — use perl for safety)
          perl -0777 -i -pe 'BEGIN { $notes = $ENV{"RELEASE_BODY"} } s/RELEASE_NOTES_PLACEHOLDER/$notes/g' appcast.xml

      # ── Upload DMG to GitHub Release ──
      - name: Upload DMG to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          CHECKSUM=$(shasum -a 256 "$APP_NAME-$VERSION.dmg" | cut -d ' ' -f 1)

          # Upload versioned DMG + stable-name DMG for latest permalink
          gh release upload "v$VERSION" \
            "$APP_NAME-$VERSION.dmg" \
            "$APP_NAME.dmg" \
            --clobber

          # Append checksum to release notes
          EXISTING_NOTES=$(gh release view "v$VERSION" --json body -q .body)
          gh release edit "v$VERSION" \
            --notes "${EXISTING_NOTES}

          ---
          **SHA-256:** \`$CHECKSUM\`"

      # ── Publish appcast to updates repo (GitHub Pages) ──
      - name: Publish appcast
        env:
          UPDATES_PAT: ${{ secrets.UPDATES_PAT }}
        run: |
          git clone https://x-access-token:${UPDATES_PAT}@github.com/1devstudio/clawdeck-updates.git deploy
          cp appcast.xml deploy/

          cd deploy
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add appcast.xml
          git commit -m "Release v${GITHUB_REF_NAME#v}" || echo "No changes"
          git push origin main

      # ── Cleanup keychain ──
      - name: Cleanup
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
